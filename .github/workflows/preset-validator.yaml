name: Renovate Preset

on:
  pull_request:
    branches:
      - main
    paths:
      - "*.json"
      - "*.json5"
  push:
    branches:
      - main
    paths:
      - "*.json"
      - "*.json5"
  workflow_dispatch:
    inputs:
      validate_all:
        description: 'Validate all JSON/JSON5 files'
        required: false
        default: false
        type: boolean

jobs:
  get-changed-files:
    name: Get changed files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get changed json/json5 files
        if: ${{ !inputs.validate_all }}
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          escape_json: false
          files: |
            **.json
            **.json5
          json: true

      - name: Get all json/json5 files
        if: ${{ inputs.validate_all }}
        id: all-files
        run: |
          files=$(find . -type f \( -name "*.json" -o -name "*.json5" \) -not -path "*/node_modules/*" -not -path "*/.git/*" | jq -R -s -c 'split("\n")[:-1]')
          echo "all_files=$files" >> $GITHUB_OUTPUT
          if [ -n "$files" ] && [ "$files" != "[]" ]; then
            echo "any_files=true" >> $GITHUB_OUTPUT
          else
            echo "any_files=false" >> $GITHUB_OUTPUT
          fi

    outputs:
      any-changed: ${{ inputs.validate_all && steps.all-files.outputs.any_files || steps.changed-files.outputs.any_changed }}
      matrix: ${{ inputs.validate_all && steps.all-files.outputs.all_files || steps.changed-files.outputs.all_changed_files }}

  renovate-preset-validation:
    if: ${{ fromJson(needs.get-changed-files.outputs.any-changed) }}
    needs: get-changed-files
    name: Validate

    strategy:
      fail-fast: false
      matrix:
        files: ${{ fromJson(needs.get-changed-files.outputs.matrix) }}

    uses: mikesmitty/renovate-config/.github/workflows/validator.yaml@main
    with:
      config_file_path: ${{ matrix.files }}
